# 小程序基本功能及万家灯火智慧社区项目讲解

### [一、小程序的跳转方式](#一、小程序的跳转方式)
### [二、小程序setData方法详解和注意事项：](###二、小程序setData方法详解和注意事项：)

### 一、小程序的跳转方式

- wx.switchTab() **（不可带参）** **跳转到tabBar页面，并关闭其他所有非tabBar页面。** 在小程序中使用时，只能在当前插件的页面中调用
  
- wx.navigateTo()**（可带参）**  **保留当前页面，跳转到应用内的某个页面。但是不能跳到tabBar页面。** 使用wx.navigateBack可以返回到原页面。小程序中的页面栈最多十层。在小程序中使用时，只能在当前插件的页面中调用 
  
- wx.redirectTo()**（可带参）**  **关闭当前页面，跳转到应用内的某个页面。但是不允许跳转到tabBar页面。** 在小程序中使用时，只能在当前插件的页面中调用
- wx.reLaunch()**（可带参）** 	 **关闭所有页面，打开到应用内的某个页面。** 在小程序中使用时，只能在当前插件的页面中调用
- wx.navigateBack() **（不可带参）**  **关闭当前页面，返回上一页面或多级页面。** 可通过getCurrentPages获取当前页面栈，决定需要返回几层。在小程序中使用时，只能在当前插件的页面中调用
- 总结：

  **switchTab这种导航方式，不能带参，也就是说不能通过url进行传参，解决方法就是如果要跳转到tab页面，使用reLaunch方法**

### 二、小程序setData方法详解和注意事项：

* 1. 什么是setData ？
    - setData是小程序开发中使用最频繁的接口，也是最容易引发性能问题的接口。
    - setData函数用于将数据从逻辑层渲染到视图层（异步），同时改变对应的this.data的值（同步）。
  
* 2. setData 如何使用？
    - 参数接受一个对象，以key，value的形式表示；
    ```javascript
    this.setData({
        key: value
    })
    ```
    - 参数和变量名一致，可以用一个值代替
    ```javascript
    this.setData({
        test
    })
    ```
    - 可以设置一个或者多个data数据，用逗号连接
    ```javascript
    this.setData({
        key: value,
        key: value,
    })
    ```
    - key可以以数据路径的形式给出
    ```javascript
    this.setData({
        'list[0].title': 'demo'        //数据路径key必须带 ‘’ 号
    })
    ```
    - key值可以为变量，为变量的时候要用 [] 引起来
    ```javascript
    this.setData({
        ['list['+index+'].title']: 'demo'
    })
    ```
    - 修改wx.navigateBack（）方法返回的时候，前一页的data值
    ```javascript
    let pages = getCurrentPages();   // 页面栈
    let prevPage = pages[pages.length - 2];   //上一个页面
    prevPage.setData({
        key: value
    })
    ```
* 2. 注意事项
  - 直接修改this.data,虽然会改变数据，但是页面不会重新渲染，无法改变页面状态，会造成数据不一致的情况
  - 但系设置的数据不能超过1024KB，请尽量避免一次设置过多的数据
  - 不需要在this.data中预先定义，使用setData()方法会自动创建该数据
  

### 三、小程序页面间传参
- 1、使用navigator的url带参传值
   - （1）在A页面有一个参数要传给B页面
   ```javascript
    <navigator url="../index/pageB?user_id='12345678'">index4</navigator> // ？后面为你要传递的值
    ```
    然后在B页面的onLoad函数中进行获取
    ```javascript
    onLoad: function (options) {
        this.setData({
            user_id:options.user_id  //options里面为你传递过来的参数
        })
        console.log(this.data.user_id)
    },
    ```
    - （2）在一般情况下我们要传多个值，与上面的差不多，只是多加了一个&
    pageA
    ```javascript
    <navigator url="../index/pageB?user_id='12345678'&user_name='lhs'">index</navigator>
    ```
    pageB
    ```javascript
    onLoad: function (options) {
        this.setData({
            user_id:options.user_id,
            user_name: options.user_name,
        })
        console.log(this.data.user_id)
        console.log(this.data.user_name)
    },
    ```

### 四、小程序目录结构
* api
  - **api.js：** 根据base.js里面对wx.request（）的封装出的所有API请求的url
  - **base.js：** 对wx.request（）的封装，这里封装的请求方法，主要在于判断token的过期，需要重新请求token在进行接口的请求
  > 
  > token获取分为两种：
  > 1. 第一次登陆小程序需要用 wx.login 获得code后然后请求后台获得token
  > 2. token过期后，需要 通过刷新token的接口去重新获得新的token
  ---
* compontents 
  - **changeCell（切换小区组件）**    
  因小程序的几乎每个页面都有切换小区的需求，而对切换小区进行了整体的封装
  主要功能：
  1）切换小区功能完成需要三个参数，省市和小区名字，选择完毕后需要把选择的信息记录到缓存，因为每个页面都需要这个小区的相关数据，点击确定的时候需要把所有的参数传递给父组件
  2）点击关闭按钮需要判断，如果缓存中有小区相关数据可以关闭，如果没有，点击关闭时，提示必须选择小区
  - **titlenavgation(头部title组件)**
  因切换小区后不能实时的查看当前选择的小区，我们把展示当前小区名字的功能放在头部
  主要功能：
  1）每次切换小区确定后把数据传给页面，再由页面传递给这个组件，从而刷新头部小区名字
  ---
* pages
  - **bindCell（绑定小区、绑定家属）**
  主要功能：绑定分为两种情况：绑定房屋入口进入，添加家属入口
    - **绑定房屋入口：**
    1、根据进来的参数展示获取楼栋的picker，然后依次进行操作，
    2、选到房间号的时候需要和后台请求下当前房屋是否进行了绑定，如果接口查询到了该房子绑定了业主，需要让原业主获取验证码并进行验证，如果没查到业主绑定，直接进行下一步
    3、与业主关系，如果选择了本人，需要展示房屋的一些信息，并且身份证号和真实姓名必须通过身份证识别添加，如果选择了其他关系不需要展示房屋信息，并且身份证号和真实姓名可以识别也可以添加
    4、职业需要弹层进行触发，如果最后选择的职业里面包含其他，则需要进行手动输入真实职业
    5、上传人脸照片时需要房屋的相关信息，所以不选择房屋信息时是不可以上传照片的
    6、如果业主提交过一次申请后，前台需要将个人信息进行缓存存储，并且在进入页面的时候将信息带入，如果与业主关系选择本人以外的需要再将数据清除
    - **添加家属入口：**
    1、和绑定房屋不同，根据携带参数获取当前账号绑定的房屋列表供选择
    2、与业主关系里面需要去除本人选项，身份证号和真实姓名可以识别可以输入
    3、其他功能同上
    ---
  - **houseDetails（房屋详情）**
    主要功能：页面初始化时，根据列表入口的不同分为两种情况
    - 审核通过的房屋：显示当前审核通过的房子的相关数据，下面还有四个家庭成员的tab，分别是已绑定、未绑定、已激活、未激活，根据后台返回数据进行相关交互操作
    1、已绑定：如果是业主添加的家属，需要点击邀请激活按钮，邀请家属进行激活。激活成功后，该成员下有三个按钮，授权 管理（授权当前家属具有绑定其他家属的权限）授权支付（授权当前家属具有支付当前绑定房屋的费用的权限）解绑（解除当前家属与房屋的绑定，需要审核）
     2、未绑定：添加的家属未通过审核
    3、已激活：添加的家属已经激活过了
    4、未激活：添加的家属未激活需要邀请家属激活
    审核中或者未通过审核的房屋：显示当前审核状态和绑定时添加的一标三实的所有数据，并且有删除按钮
    ---
  - **houseList/ownerHouseList（房屋列表）**
    主要功能：房屋列表分为两种类型：绑定列表和解绑列表
    - 1、绑定列表：显示业主和家属的绑定房屋的列表，状态有审核中，审核已通过，未通过审核，需要根据接口返回展示当前房屋状态并且在状态是审核已通过的时候可以左滑删除，未通过和审核中不能左滑
      2、解绑列表：显示业主对当前房屋的解绑状态，也分为审核中、审核已通过、未通过，如果解绑成功后左滑需要展示删除按钮
    ---
  - **houseList（房屋列表）**
    主要功能：房屋列表分为两种类型：绑定列表和解绑列表
    - 1、绑定列表：显示业主和家属的绑定房屋的列表，状态有审核中，审核已通过，未通过审核，需要根据接口返回展示当前房屋状态
                      并且在状态是审核已通过的时候可以左滑删除，未通过和审核中不能左滑
    2、解绑列表：显示业主对当前房屋的解绑状态，也分为审核中、审核已通过、未通过，如果解绑成功后左滑需要展示删除按钮
  ---
  - **lifePay（生活缴费）**
    主要功能：生活缴费分为两种类型：待缴费列表和已缴费列表
    - 1、待缴费：待缴费里面需要根据接口返回展示，然后有详情按钮，点击按钮展开缴费项的其他信息，最主要的缴费是可以合并缴费的可以多选和全选，并且需要展示给用户看缴费的合并金额
      2、已缴费：已缴费和为缴费的展示是相同的，就是没有了多选框和支付相关操作
    ---
  - **login（登录）**
    主要功能：登录分为两种方式：微信手机号授权登录和手机号验证码登录，两种方式登录后都需要把登录成功后的token和用户信息进行缓存
    - 1、授权微信手机号登录主要分为两点，一是授权小程序获取微信手机号，然后还需要让用户授权获取用户信息
      2、手机号验证码登录点击后展示输入手机号和验证码输入框，登录按钮上需要添加让用户获取用户信息
    ---
  - **notice（公告通知）**
    主要功能：初始化接口返回公告列表，直接展示就可以

    ---
  - **notice/details（公告通知列表）**
    主要功能：初始化接口返回公告列表，直接展示就可以，有个查看大图功能，需要注意点击哪个从哪个图片开始展示

    ---
  - **personal（我的）**
    主要功能：主要就是列表入口，还有在登录时候的缓存的用户信息需要展示，如果缓存中没有拿到，需要跳转到登录页面进行获取

    ---
  - **phoneCall（应急电话）**
    主要功能：目前是我在前台写死的数据，后期会改成后台返回，这个页面比较简单，列表循环就可以，然后调取拨打电话的api

    ---
  - **property（首页）**
    主要功能：
    1）首页的各个入口的权限不同，需要不能权限才能进入相关入口
    2）每次进入小程序进行检测如果缓存中没有小区数据，需要弹层显示切换小区
    3）第一次进入小程序，必须展示选小区的弹层，因为每个页面都需要小区的参数。
    4）各个入口的权限：
    - 1、绑定房屋：根据缓存中有没有token，如果有token并且没有过期，可以访问；如果没有token需要跳转登录页获取token后，可以访问；
    2、添加家属：同上先判断token，再根据接口返回的权限是否为HouseMember，如果是HouseMember并且已经绑定房屋且审核通过，可以访问
    3、生活缴费，物业报修，投诉建议，同上
    4、公告通知同上绑定房屋
    5、应急电话可以不登录就直接访问
    ---
  - **proposal（添加投诉建议）**
  主要功能：主要是表单验证然后请求接口上传信息

    ---
  - **phoneCall（应急电话）**
  主要功能：主要是表单验证然后请求接口上传信息

---
- static（静态文件，目前就是放置小程序需要的所有图片）
- utils（公共方法封装：例如存缓存、取缓存、showToast提示）
- app.js（为了公共头部，初始化了小程序头部的高度，存在全局变量中。每个页面初始化的时候需要从全局变量中获取高度，并且在页面的最外层结构上动态添加高度）
- app.json（）
